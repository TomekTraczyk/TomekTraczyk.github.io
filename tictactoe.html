<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Strona o Shreku</title>
    <link rel="stylesheet" href="public/styles.css">
    <link rel="icon" href="public/images/shrek.webp">
</head>
<body>
<header>
    <h1>Kółko i krzyżyk</h1>
</header>

<nav>
    <ul>
        <li><a href="#">O Shreku</a></li>
        <li><a href="#">Postacie</a></li>
        <li><a href="#">Galeria</a></li>
        <li><a href="#">Kontakt</a></li>
        <li><a href="/TomekTraczyk.github.io/tictactoe.html">Kółko i krzyżyk</a></li>
    </ul>
</nav>

<div class="content">
    <div>
        <h2>
            Wybierz tryb gry:
        </h2>
        <select id="game-type-select">
            <option data-id="0">Gra we dwie osoby</option>
            <option data-id="1">Gra samemu (z komputerem)</option>
        </select>
    </div>

    <div>
        <h2>
            Wybierz kim gra ropoczynający<br>
            (gracz w przypadku gry z komputerem):
        </h2>
        <select id="game-icon-select">
            <option data-id="0">Shrek</option>
            <option data-id="1">Osioł</option>
        </select>
    </div>
    <div style="margin-top: 20px">
        <button id="start-game" type="button">start</button>
    </div>
    <div id="game-info" style="text-align: center">&nbsp</div>
    <div class="ttt-container">
        <div class="ttt-board">
            <div class="row">
                <div data-id="0" data-pressed-by="0" class="ttt-square"></div>
                <div data-id="1" data-pressed-by="0" class="ttt-square"></div>
                <div data-id="2" data-pressed-by="0" class="ttt-square"></div>
            </div>
            <div class="row">
                <div data-id="3" data-pressed-by="0" class="ttt-square"></div>
                <div data-id="4" data-pressed-by="0" class="ttt-square"></div>
                <div data-id="5" data-pressed-by="0" class="ttt-square"></div>
            </div>
            <div class="row">
                <div data-id="6" data-pressed-by="0" class="ttt-square"></div>
                <div data-id="7" data-pressed-by="0" class="ttt-square"></div>
                <div data-id="8" data-pressed-by="0" class="ttt-square"></div>
            </div>
        </div>
    </div>
</div>


<footer>
    <p>&copy; 2023 Tomasz Traczyk</p>
</footer>

<script>
    window.onload = () => {
        let gameBoard = document.querySelector('.ttt-board');
        let gameSquares = document.querySelectorAll('.ttt-square');
        let typeSelect = document.querySelector('#game-type-select');
        let iconSelect = document.querySelector('#game-icon-select');
        let gameInfo = document.querySelector('#game-info');
        let gameOn = false;
        let shrekTurn;
        let normalMode;


        document.querySelector('#start-game').addEventListener('click', () => {
            shrekTurn = iconSelect.selectedIndex === 0;
            normalMode = typeSelect.selectedIndex === 0;
            gameInfo.innerHTML = 'Ruch gracza ' + (shrekTurn ? 'shrek' : 'osioł');
            gameOn = true;
            clearBoard();
            gameSquares.forEach(gameSquare => {
                gameSquare.addEventListener('click', () => {
                    if (gameSquare.dataset['pressedBy'] === "0" && gameOn) {
                        gameSquare.classList.add(shrekTurn ? 'shrek' : 'donkey')
                        gameSquare.dataset['pressedBy'] = shrekTurn ? 'shrek' : 'donkey';
                        let winner = checkForWin();
                        if (document.querySelectorAll("[data-pressed-by='0']").length === 0) {
                            gameOn = false;
                            gameInfo.innerHTML = 'Remis!';
                        }
                        if (normalMode && gameOn) {
                            shrekTurn = !shrekTurn;
                            gameInfo.innerHTML = 'Ruch gracza ' + (shrekTurn ? 'shrek' : 'osioł');
                        } else if(gameOn) {
                            makeBotMove(shrekTurn);
                            winner = checkForWin();
                        }
                        if (winner) {
                            gameInfo.innerHTML = 'Wygrał ' + winner + '!';
                        }
                    }
                })
            })
        })

        let clearBoard = () => {
            gameSquares.forEach(gameSquare => {
                gameSquare.dataset['pressedBy'] = '0';
                gameSquare.className = 'ttt-square';
            })
        }

        let checkForWin = () => {
            let shrekSquares = document.querySelectorAll('.ttt-square.shrek');
            let donkeySquares = document.querySelectorAll('.ttt-square.donkey');

            let shrekSquareIds = Array.from(shrekSquares).map(x => parseInt(x.dataset['id']));
            let donkeySquareIds = Array.from(donkeySquares).map(x => parseInt(x.dataset['id']));

            let winner = '';

            if (shrekSquareIds.length >= 3 || donkeySquareIds.length >= 3) {
                winningPositions.forEach(winningPosition => {
                    let shrekWon = true;
                    let donkeyWon = true;
                    winningPosition.forEach(squareId => {
                        if (!shrekSquareIds.includes(squareId)) {
                            shrekWon = false;
                        }

                        if (!donkeySquareIds.includes(squareId)) {
                            donkeyWon = false;
                        }
                    })

                    if (donkeyWon || shrekWon) {
                        gameOn = false;
                        winner = shrekWon ? 'shrek' : 'osioł';
                    }
                })
            }

            return winner;
        }

        let makeBotMove = (shrekTurn) => {
            let gameSquare = checkForBlockingMoves(shrekTurn);

            if (gameSquare) {
                gameSquare.classList.add(!shrekTurn ? 'shrek' : 'donkey')
                gameSquare.dataset['pressedBy'] = !shrekTurn ? 'shrek' : 'donkey';
            } else {
                let freeSquares = document.querySelectorAll("[data-pressed-by='0']");
                let index = Math.floor(Math.random() * freeSquares.length);
                freeSquares[index].classList.add(!shrekTurn ? 'shrek' : 'donkey')
                freeSquares[index].dataset['pressedBy'] = !shrekTurn ? 'shrek' : 'donkey';
            }
        }

        let checkForBlockingMoves = (shrekTurn) => {
            let blockSquare;
            let opponentSquares = document.querySelectorAll('.ttt-square.' + (shrekTurn ? 'shrek' : 'donkey'));
            opponentSquares = Array.from(opponentSquares).map(x => parseInt(x.dataset['id']));
            if (opponentSquares.length >= 2) {
                winningPositions.forEach(winningPosition => {
                    let movesArray = [...winningPosition];
                    winningPosition.forEach(squareId => {
                        if (opponentSquares.includes(squareId)) {
                            let index = movesArray.indexOf(squareId);
                            if (index > -1) {
                                movesArray.splice(index, 1);
                            }
                        }
                    })

                    if (movesArray.length === 1) {
                        let gameSquare = document.querySelector("div[data-id='" + movesArray[0] +"']");
                        if (gameSquare.dataset['pressedBy'] === '0') {
                            blockSquare = gameSquare;
                        }
                    }
                })
            }

            return blockSquare;
        }

        let winningPositions = [
            [0,1,2],
            [3,4,5],
            [6,7,8],
            [0,3,6],
            [1,4,7],
            [2,5,8],
            [0,4,8],
            [2,4,6]
        ];
    }
</script>

</body>
</html>
